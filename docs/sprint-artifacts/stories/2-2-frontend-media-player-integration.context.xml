<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Frontend Media Player Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-2-frontend-media-player-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to see and control media playback within the transcription review interface</iWant>
    <soThat>I can listen to the recording while reviewing text</soThat>
    <tasks>
- Task 1: Create MediaPlayer.vue component (AC: #1, #2, #3, #4)
  - Create `frontend/src/components/MediaPlayer.vue` with TypeScript setup
  - Implement automatic video/audio element selection based on media type detection
  - Add props: `mediaUrl: string`, `jobId: string`
  - Render HTML5 `&lt;video&gt;` or `&lt;audio&gt;` element with native controls
  - Set `src` attribute to GET /media/{job_id} endpoint URL
  - Add `controls` attribute for play, pause, seek bar, volume, current time
  - Test: Component renders video element for MP4 files
  - Test: Component renders audio element for MP3, WAV, M4A files
  - Test: Native controls are visible and functional

- Task 2: Implement Pinia store state synchronization (AC: #8)
  - Extend `frontend/src/stores/transcription.ts` with player state fields:
    - `currentTime: number` (commanded seek position)
    - `playbackTime: number` (actual player position)
    - `isPlaying: boolean` (play/pause state)
  - Add store action: `seekTo(time: number)` to update currentTime
  - Add store action: `updatePlaybackTime(time: number)` to update playbackTime
  - Add store action: `setIsPlaying(playing: boolean)` to update isPlaying
  - Test: Store actions update state correctly
  - Test: Store state changes are reactive

- Task 3: Implement player event handlers for state sync (AC: #8)
  - Add `@timeupdate` event handler in MediaPlayer.vue
  - Throttle timeupdate events to 250ms using lodash-es `throttle()`
  - Call `store.updatePlaybackTime(player.currentTime)` in throttled handler
  - Add `@play` event handler to call `store.setIsPlaying(true)`
  - Add `@pause` event handler to call `store.setIsPlaying(false)`
  - Add `@ended` event handler to call `store.setIsPlaying(false)`
  - Test: timeupdate events update store.playbackTime (throttled)
  - Test: play/pause events update store.isPlaying correctly

- Task 4: Implement commanded seek watching (AC: #6, #8)
  - Add `watch(() =&gt; store.currentTime)` in MediaPlayer.vue
  - In watch callback: Check if `|player.currentTime - store.currentTime| &gt; 0.5s`
  - If true: Set `player.currentTime = store.currentTime` (seek player)
  - Respect isPlaying state: Only auto-play if `store.isPlaying === true`
  - Test: Changing store.currentTime seeks player
  - Test: Seeking preserves play/pause state
  - Test: Small time differences (&lt;0.5s) don't trigger unnecessary seeks

- Task 5: Integrate MediaPlayer into ResultsView.vue (AC: #1, #7)
  - Open `frontend/src/views/ResultsView.vue`
  - Replace media player placeholder (line ~109: "Media Player (Coming in Epic 2)")
  - Import MediaPlayer component: `import MediaPlayer from '@/components/MediaPlayer.vue'`
  - Add `&lt;MediaPlayer :mediaUrl="mediaUrl" :jobId="jobId" /&gt;` above SubtitleList
  - Compute `mediaUrl` from `jobId`: `http://localhost:8000/media/${jobId}`
  - Ensure 16:9 aspect ratio container (`aspect-video` Tailwind class) surrounds player
  - Test: MediaPlayer displays above subtitle list in ResultsView
  - Test: Player scales responsively on mobile/tablet viewports

- Task 6: Implement localStorage edit restoration on component mount (AC: #5)
  - Add `onMounted()` lifecycle hook in ResultsView.vue or store
  - Check localStorage for key: `klipnote_edits_{jobId}`
  - If exists: Parse JSON and restore to `store.segments`
  - If exists: Display UI feedback: "Restored unsaved edits from [timestamp]"
  - If not exists: Fetch transcription from API as normal (existing behavior)
  - Catch JSON parse errors: Log warning, fall back to API fetch
  - Test: localStorage edits override API results on page load
  - Test: Corrupted localStorage data falls back to API gracefully

- Task 7: Add lodash-es dependency for throttle utility (AC: #3)
  - Run: `cd frontend &amp;&amp; npm install lodash-es`
  - Run: `npm install --save-dev @types/lodash-es` (TypeScript types)
  - Verify package.json updated with lodash-es dependency
  - Import throttle in MediaPlayer.vue: `import { throttle } from 'lodash-es'`
  - Test: Throttle function works correctly in timeupdate handler

- Task 8: Validate Range request support and smooth seeking (AC: #6)
  - Open browser DevTools Network tab
  - Load ResultsView with MediaPlayer
  - Seek player using native seek bar (drag timeline)
  - Verify Network tab shows Range request headers (e.g., `Range: bytes=0-1023`)
  - Verify server responds with `206 Partial Content` status
  - Verify `Content-Range` header present in response
  - Verify seeking is smooth (&lt;1s response time per NFR001)
  - Test on slow network: Throttle to "Slow 3G" in DevTools, verify seeking still works

- Task 9: Component testing with Vitest (AC: all)
  - Create `frontend/src/components/MediaPlayer.test.ts`
  - Test: Component renders video element when mediaUrl ends with .mp4
  - Test: Component renders audio element when mediaUrl ends with .mp3
  - Test: Player seeks when store.currentTime changes
  - Test: store.playbackTime updates on timeupdate event (throttled)
  - Test: store.isPlaying updates on play/pause events
  - Test: Player respects isPlaying state when seeking
  - Run: `npm run test:unit` and verify all tests pass
    </tasks>
  </story>

  <acceptanceCriteria>
1. Integrated HTML5 video/audio player displayed above subtitle list
2. Player automatically selects correct element (video/audio) based on media type
3. Standard controls visible: play, pause, seek bar, volume, current time
4. Player loads media from GET /media/{job_id} endpoint
5. On load: Check localStorage for existing edits (key: `klipnote_edits_{job_id}`) and restore if present
6. Seeking works smoothly (Range request support validated)
7. Responsive layout: player scales appropriately on mobile/tablet
8. Player state persists during subtitle editing (doesn't reload unnecessarily)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR012 - Media Player Requirement</section>
        <snippet>System shall provide integrated media player supporting play, pause, and seek controls</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>MediaPlayer Component - Services and Modules</section>
        <snippet>HTML5 video/audio player with state sync. Inputs: mediaUrl, store state. Outputs: Player DOM element, playback events. Location: frontend/src/components/MediaPlayer.vue</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Data Models - TranscriptionState Interface</section>
        <snippet>Store state extensions: currentTime (commanded seek), playbackTime (actual position), activeSegmentIndex, isPlaying, editingSegmentId</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Click-to-Timestamp Synchronization Pattern</section>
        <snippet>Bidirectional sync between subtitle list and media player. MediaPlayer watches store.currentTime for seeks, updates store.playbackTime on timeupdate events (throttled 250ms)</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-1-media-playback-api-endpoint.md</path>
        <title>Story 2.1 - Media Playback API Endpoint</title>
        <section>Dev Agent Record - Backend Infrastructure Ready</section>
        <snippet>GET /media/{job_id} endpoint operational at backend/app/main.py:302-394. HTTP Range support via FastAPI FileResponse. Returns 206 Partial Content with Content-Range headers. 16/16 tests passing.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>frontend/src/views/ResultsView.vue</path>
        <kind>view</kind>
        <symbol>Media Player Placeholder</symbol>
        <lines>107-144</lines>
        <reason>Lines 107-144 contain the media player placeholder that needs to be replaced with actual MediaPlayer component. Currently shows "Media Player (Coming in Epic 2)" message.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/stores/transcription.ts</path>
        <kind>store</kind>
        <symbol>useTranscriptionStore</symbol>
        <lines>1-57</lines>
        <reason>Pinia store that needs to be extended with player state fields: currentTime, playbackTime, isPlaying. Currently has: jobId, status, progress, message, segments, error.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/SubtitleList.vue</path>
        <kind>component</kind>
        <symbol>SubtitleList</symbol>
        <lines>all</lines>
        <reason>Existing subtitle display component created in Story 1.7. Will be used below MediaPlayer in ResultsView layout.</reason>
      </artifact>
      <artifact>
        <path>backend/app/main.py</path>
        <kind>endpoint</kind>
        <symbol>serve_media</symbol>
        <lines>302-394</lines>
        <reason>GET /media/{job_id} endpoint implemented in Story 2.1. Provides HTTP Range support for media streaming. MediaPlayer will consume this endpoint.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/services/api.ts</path>
        <kind>service</kind>
        <symbol>API client</symbol>
        <lines>all</lines>
        <reason>Existing API service layer. May need getMediaUrl() helper function to construct media endpoint URL.</reason>
      </artifact>
    </code>
    <dependencies>
      <frontend>
        <existing>
          <package name="vue" version="^3.5.22">Vue 3 framework with Composition API</package>
          <package name="vue-router" version="^4.6.3">Client-side routing</package>
          <package name="pinia" version="^3.0.3">State management (transcription store)</package>
          <package name="typescript" version="~5.9.0">Type safety</package>
          <package name="vite" version="^7.1.11">Build tool and dev server</package>
          <package name="vitest" version="^3.2.4">Testing framework</package>
          <package name="@vue/test-utils" version="^2.4.6">Vue component testing utilities</package>
          <package name="tailwindcss" version="^4.1.16">Utility-first CSS framework</package>
        </existing>
        <new-required>
          <package name="lodash-es" version="^4.17.21">Throttle utility for timeupdate and localStorage writes (Task 7)</package>
          <package name="@types/lodash-es" version="^4.17.x" dev="true">TypeScript types for lodash-es</package>
        </new-required>
      </frontend>
      <backend>
        <existing>
          <package name="fastapi">Media serving endpoint already implemented in Story 2.1</package>
          <note>No backend changes required for this story - GET /media/{job_id} endpoint operational</note>
        </existing>
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>MediaPlayer must use HTML5 native video/audio elements - no third-party player libraries</constraint>
    <constraint>Player state sync must be bidirectional: store changes trigger player seeks, player events update store</constraint>
    <constraint>Timeupdate events must be throttled to 250ms to prevent excessive store updates (performance requirement)</constraint>
    <constraint>Seek threshold: Only update player.currentTime if difference &gt; 0.5s to avoid unnecessary seeks</constraint>
    <constraint>Respect isPlaying state: When seeking via store.currentTime, only auto-play if store.isPlaying === true</constraint>
    <constraint>Component must automatically select video vs audio element based on media type detection from URL</constraint>
    <constraint>Use Tailwind CSS classes for styling - maintain consistency with existing Stitch design system</constraint>
    <constraint>Player must not reload during subtitle editing (state persistence requirement)</constraint>
    <constraint>localStorage recovery: Check for existing edits on mount before loading media (AC #5)</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>GET /media/{job_id}</name>
      <kind>REST endpoint</kind>
      <signature>GET http://localhost:8000/media/{job_id}</signature>
      <path>backend/app/main.py:302-394</path>
      <description>Media streaming endpoint with HTTP Range support. Returns media file with Content-Type headers. Supports 206 Partial Content for seeking.</description>
    </interface>
    <interface>
      <name>TranscriptionStore - New Actions</name>
      <kind>Pinia store actions</kind>
      <signature>seekTo(time: number), updatePlaybackTime(time: number), setIsPlaying(playing: boolean)</signature>
      <path>frontend/src/stores/transcription.ts</path>
      <description>New store actions to be added for player state synchronization. seekTo commands player seeks, updatePlaybackTime tracks actual position, setIsPlaying syncs play/pause state.</description>
    </interface>
    <interface>
      <name>MediaPlayer Component Props</name>
      <kind>Vue component interface</kind>
      <signature>mediaUrl: string, jobId: string</signature>
      <path>frontend/src/components/MediaPlayer.vue (to be created)</path>
      <description>MediaPlayer component receives mediaUrl prop for src attribute and jobId for localStorage checks</description>
    </interface>
    <interface>
      <name>localStorage Edit Recovery</name>
      <kind>Browser API</kind>
      <signature>localStorage.getItem('klipnote_edits_{job_id}')</signature>
      <path>frontend/src/views/ResultsView.vue or store</path>
      <description>Check localStorage on component mount for existing edits. Key pattern: klipnote_edits_{job_id}. If exists, restore to store.segments before loading media.</description>
    </interface>
  </interfaces>
  <tests>
    <standards>Frontend testing uses Vitest + @vue/test-utils framework (already configured in Epic 1). Coverage target: 70%+ frontend coverage. Component tests should verify rendering, props, events, and state synchronization. Manual browser testing required for Range request validation and responsive layout testing.</standards>
    <locations>
      <location>frontend/src/components/MediaPlayer.test.ts - Component unit tests (to be created)</location>
      <location>frontend/src/__tests__/components/ - Additional component tests directory</location>
      <location>frontend/src/stores/transcription.test.ts - Store action tests (existing, needs extension)</location>
    </locations>
    <ideas>
      <test ac="1,2,3">MediaPlayer component renders video element for MP4 files and audio element for MP3/WAV/M4A files</test>
      <test ac="3">Native controls are visible and functional (play, pause, seek bar, volume, time display)</test>
      <test ac="4">Component correctly constructs mediaUrl from jobId prop (http://localhost:8000/media/{jobId})</test>
      <test ac="6,8">Player seeks when store.currentTime changes (watch mechanism test)</test>
      <test ac="6">Seek threshold test: Small time differences (&lt;0.5s) don't trigger unnecessary seeks</test>
      <test ac="8">store.playbackTime updates on timeupdate event (throttled to 250ms)</test>
      <test ac="8">store.isPlaying updates correctly on play/pause/ended events</test>
      <test ac="8">Player respects isPlaying state when seeking (doesn't auto-play if paused)</test>
      <test ac="5">localStorage recovery: Check localStorage.getItem('klipnote_edits_{jobId}') on mount</test>
      <test ac="5">Corrupted localStorage data falls back to API fetch gracefully (JSON parse error handling)</test>
      <test ac="6">Manual browser test: Open DevTools Network tab, verify Range request headers (Range: bytes=0-1023)</test>
      <test ac="6">Manual browser test: Verify server responds with 206 Partial Content status and Content-Range header</test>
      <test ac="7">Responsive layout test: Verify player scales on mobile (375px), tablet (768px), desktop (1024px) viewports</test>
      <test ac="1">Integration test: MediaPlayer displays above SubtitleList in ResultsView.vue</test>
    </ideas>
  </tests>
</story-context>
