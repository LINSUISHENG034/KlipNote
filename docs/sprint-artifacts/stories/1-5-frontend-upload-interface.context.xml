<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Frontend Upload Interface</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-5-frontend-upload-interface.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>a simple web page to upload my media file</iWant>
    <soThat>I can start using KlipNote without technical knowledge</soThat>
    <tasks>
      - Initialize Vue 3 + Vite project structure (AC: #1, #7)
      - Create UploadView.vue landing page (AC: #1, #7)
      - Create FileUpload.vue component with drag-and-drop (AC: #2, #8)
      - Implement API client service (AC: #3)
      - Integrate upload flow with navigation (AC: #3, #4, #5)
      - Add CORS middleware to backend (AC: #3)
      - Implement responsive design and cross-browser compatibility (AC: #6, #7)
      - Write comprehensive frontend tests (AC: #1-8)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Landing page displays file upload form with clear instructions
    2. File input accepts audio/video formats (validated client-side)
    3. Upload button triggers POST /upload API call
    4. Success: Stores job_id and navigates to progress page
    5. Failure: Displays error message from API
    6. UI works on desktop, tablet, and mobile browsers
    7. Basic responsive layout (no advanced styling required for MVP)
    8. Drag-and-drop file upload supported (drop zone with visual feedback)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/PRD.md</path>
        <title>KlipNote Product Requirements Document</title>
        <section>Functional Requirements - File Upload & Processing</section>
        <snippet>FR001: System shall accept audio and video file uploads via web interface. FR002: System shall support common media formats including MP3, MP4, WAV, M4A. NFR002: Non-technical users shall complete upload → review → export workflow without documentation.</snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>KlipNote Epic Breakdown</title>
        <section>Story 1.5: Frontend Upload Interface</section>
        <snippet>As a user, I want a simple web page to upload my media file, so that I can start using KlipNote without technical knowledge. Includes drag-and-drop support, client-side validation, and responsive design for desktop/tablet/mobile.</snippet>
      </artifact>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Core Transcription Workflow</title>
        <section>Frontend Components</section>
        <snippet>Vue 3 + TypeScript application with Vue Router for navigation, Pinia store for job state, native fetch() API for backend communication. Vite build tooling for fast HMR. Frontend upload interface in Story 1.5 implements file selection, validation, and POST /upload integration.</snippet>
      </artifact>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Core Transcription Workflow</title>
        <section>APIs and Interfaces - POST /upload</section>
        <snippet>POST /upload endpoint accepts multipart/form-data file uploads, validates file formats (MP3, MP4, WAV, M4A), validates duration ≤2 hours via ffprobe, returns {job_id: "uuid"} on success, returns 400 with {detail: "error message"} on failure.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - KlipNote</title>
        <section>Frontend Project Structure</section>
        <snippet>Vue 3 + Vite + TypeScript + Router + Pinia initialized via npm create vue. Project structure: src/main.ts, src/App.vue, src/router/, src/stores/, src/services/api.ts, src/views/, src/components/, src/types/api.ts. Native fetch() API for backend calls.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - KlipNote</title>
        <section>CORS Configuration</section>
        <snippet>FastAPI CORS middleware allows origin http://localhost:5173 (Vite dev server). Configuration: allow_credentials=True, allow_methods=["*"], allow_headers=["*"]. Backend adds middleware in main.py using CORSMiddleware.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - KlipNote</title>
        <section>API Client Pattern</section>
        <snippet>Native fetch() API in services/api.ts. uploadFile() function creates FormData with file, POSTs to /upload, parses JSON response {job_id}, throws Error with detail on failure. Do NOT set Content-Type header - browser sets multipart boundary automatically.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - KlipNote</title>
        <section>Component Structure Pattern (Vue)</section>
        <snippet>Standard Vue SFC structure: script setup lang="ts" with imports, props, emits, stores, local state, computed, methods, lifecycle hooks. Template with single root element. Scoped styles for component-specific CSS. Naming: PascalCase for components, camelCase for functions.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Decision Architecture - KlipNote</title>
        <section>Testing Strategy - Frontend</section>
        <snippet>Vitest + @vue/test-utils for component tests. Coverage target: 60%+ for frontend. Test organization: tests/components/, tests/views/. Mock fetch() using vitest.mock or MSW. Test execution: npm run test:unit -- --coverage.</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>backend/app/main.py</path>
        <kind>api-endpoint</kind>
        <symbol>upload_file</symbol>
        <lines>53-129</lines>
        <reason>POST /upload endpoint that frontend will call. Returns UploadResponse with job_id. Validates format, duration, queues Celery task. Frontend needs to match this API contract.</reason>
      </artifact>
      <artifact>
        <path>backend/app/main.py</path>
        <kind>middleware</kind>
        <symbol>CORSMiddleware configuration</symbol>
        <lines>24-30</lines>
        <reason>CORS middleware already configured but frontend may need to verify origin is included (http://localhost:5173). Task 6 verifies CORS settings allow frontend requests.</reason>
      </artifact>
      <artifact>
        <path>backend/app/models.py</path>
        <kind>data-model</kind>
        <symbol>UploadResponse</symbol>
        <lines>11-27</lines>
        <reason>Pydantic model for POST /upload response. Frontend TypeScript interface must mirror this structure: {job_id: string} with UUID v4 format.</reason>
      </artifact>
      <artifact>
        <path>frontend/package.json</path>
        <kind>config</kind>
        <symbol>dependencies and devDependencies</symbol>
        <lines>17-36</lines>
        <reason>Existing dependencies from Vue 3 starter: vue@3.5.22, pinia@3.0.3, vue-router@4.6.3, vite@7.1.11, vitest@3.2.4, typescript@5.9.0. No additional packages needed for this story.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/router/index.ts</path>
        <kind>router-config</kind>
        <symbol>Vue Router configuration</symbol>
        <lines>all</lines>
        <reason>Existing Vue Router setup from starter. Task 2 adds '/' route for UploadView. Task 5 uses router.push() to navigate to /progress/{job_id} after upload success.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <vue>^3.5.22</vue>
        <pinia>^3.0.3</pinia>
        <vue-router>^4.6.3</vue-router>
        <vite>^7.1.11</vite>
        <vitest>^3.2.4</vitest>
        <typescript>~5.9.0</typescript>
        <vue-test-utils>^2.4.6</vue-test-utils>
        <vue-tsc>^3.1.1</vue-tsc>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - Vue 3 Composition API: Use script setup lang="ts" pattern for all components
    - TypeScript: All code must have explicit types, no 'any' types except for error handling
    - Native fetch(): Use browser-native fetch() API, do NOT install axios or other HTTP libraries
    - FormData for uploads: Use FormData to construct multipart/form-data, do NOT manually set Content-Type header
    - Error handling: Catch fetch errors, parse response.json() for error.detail, display user-friendly messages
    - Naming conventions: PascalCase for components (UploadView.vue, FileUpload.vue), camelCase for functions (uploadFile, handleFileSelected)
    - File organization: Views in src/views/, reusable components in src/components/, API client in src/services/api.ts, types in src/types/api.ts
    - Responsive design: Mobile-first CSS with media queries for tablet (768px) and desktop breakpoints
    - Touch-friendly: Button sizes ≥44x44px on mobile for accessibility
    - CORS requirement: Backend CORS middleware must include http://localhost:5173 origin
    - No Pinia store yet: Story 1.6 creates transcription store, this story uses local component state only
    - Route structure: / (UploadView), /progress/{job_id} (Story 1.6), /results/{job_id} (Story 1.7)
  </constraints>

  <interfaces>
    <interface>
      <name>POST /upload</name>
      <kind>REST API endpoint</kind>
      <signature>
        POST http://localhost:8000/upload
        Content-Type: multipart/form-data
        Body: file (UploadFile)

        Success Response (200):
        {
          "job_id": "550e8400-e29b-41d4-a716-446655440000"
        }

        Error Response (400):
        {
          "detail": "File format not supported. Please upload MP3, MP4, WAV, or M4A."
        }

        Error Response (413):
        {
          "detail": "File size exceeds maximum limit of 2.0GB"
        }
      </signature>
      <path>backend/app/main.py:53-129</path>
    </interface>
    <interface>
      <name>UploadResponse TypeScript Interface</name>
      <kind>TypeScript type definition</kind>
      <signature>
        export interface UploadResponse {
          job_id: string
        }

        export interface ErrorResponse {
          detail: string
        }
      </signature>
      <path>frontend/src/types/api.ts (to be created)</path>
    </interface>
    <interface>
      <name>uploadFile API Function</name>
      <kind>TypeScript async function</kind>
      <signature>
        export async function uploadFile(file: File): Promise&lt;UploadResponse&gt; {
          const formData = new FormData()
          formData.append('file', file)

          const response = await fetch(`${API_BASE_URL}/upload`, {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            const error = await response.json()
            throw new Error(error.detail || 'Upload failed')
          }

          return response.json()
        }
      </signature>
      <path>frontend/src/services/api.ts (to be created)</path>
    </interface>
    <interface>
      <name>FileUpload Component Events</name>
      <kind>Vue component emit signature</kind>
      <signature>
        const emit = defineEmits&lt;{
          'file-selected': [file: File]
        }&gt;()

        // Usage in parent:
        &lt;FileUpload @file-selected="handleFileSelected" /&gt;
      </signature>
      <path>frontend/src/components/FileUpload.vue (to be created)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend testing uses Vitest + @vue/test-utils (already configured from create-vue starter). Coverage target: 60%+ for components and views. Test organization: Component tests in tests/components/, view tests in tests/views/, service tests in tests/services/. Mock fetch() using vitest.mock or MSW (Mock Service Worker). Test execution: cd frontend && npm run test:unit -- --coverage
    </standards>
    <locations>
      - frontend/src/components/__tests__/ (component tests)
      - frontend/tests/components/ (alternative location)
      - frontend/tests/views/ (view tests)
      - frontend/tests/services/ (API client tests)
    </locations>
    <ideas>
      <test id="AC1">
        <name>UploadView renders with instructions</name>
        <criteria>AC#1: Landing page displays file upload form with clear instructions</criteria>
        <idea>Mount UploadView component, verify title "KlipNote - AI Transcription" exists, verify instructions text "Upload your audio or video file to generate a transcription" is displayed, verify supported formats text "MP3, MP4, WAV, M4A" is shown</idea>
      </test>
      <test id="AC2">
        <name>FileUpload accepts audio/video formats</name>
        <criteria>AC#2: File input accepts audio/video formats (validated client-side)</criteria>
        <idea>Create synthetic File objects with type "audio/mpeg" and "video/mp4", trigger file input change event, verify file-selected event is emitted. Create File with type "application/exe", verify validation error is displayed and no event emitted.</idea>
      </test>
      <test id="AC3">
        <name>Upload button triggers POST /upload</name>
        <criteria>AC#3: Upload button triggers POST /upload API call</criteria>
        <idea>Mock fetch() using vitest.mock, select a file, click upload button, verify fetch was called with correct URL (http://localhost:8000/upload), verify FormData contains file, verify button shows loading state during upload</idea>
      </test>
      <test id="AC4">
        <name>Success navigates to progress page</name>
        <criteria>AC#4: Success: Stores job_id and navigates to progress page</criteria>
        <idea>Mock fetch() to return {job_id: "test-uuid"}, mock useRouter().push(), upload file, verify router.push() was called with "/progress/test-uuid"</idea>
      </test>
      <test id="AC5">
        <name>Failure displays error message</name>
        <criteria>AC#5: Failure: Displays error message from API</criteria>
        <idea>Mock fetch() to return 400 with {detail: "File format not supported"}, upload file, verify error message is displayed in UI with text "File format not supported"</idea>
      </test>
      <test id="AC8">
        <name>Drag-and-drop highlights zone</name>
        <criteria>AC#8: Drag-and-drop file upload supported (drop zone with visual feedback)</criteria>
        <idea>Simulate dragover event on FileUpload component, verify CSS class "drag-over" is added. Simulate drop event with File in dataTransfer, verify file-selected event is emitted, verify "drag-over" class is removed.</idea>
      </test>
    </ideas>
  </tests>
</story-context>
