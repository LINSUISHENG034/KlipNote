<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1</storyId>
    <title>Project Scaffolding and Development Environment</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-1-project-scaffolding-and-development-environment.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>the project structure and development environment configured</iWant>
    <soThat>I can begin building features on a solid foundation</soThat>
    <tasks>
- Task 1: Initialize backend FastAPI project structure (AC: #1, #3)
- Task 2: Initialize frontend Vue 3 + Vite project (AC: #2, #3)
- Task 3: Integrate WhisperX as git submodule (AC: #4)
- Task 4: Configure Git repository (AC: #5)
- Task 5: Create basic README with setup instructions (AC: #6)
- Task 6: Validate development servers run successfully (AC: #7)
- Task 7: Setup testing infrastructure (Testing Strategy requirement)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Backend: FastAPI project initialized with proper directory structure (api/, models/, services/, tasks/)
2. Frontend: Vue 3 + Vite project initialized with component structure
3. Dependencies installed: FastAPI, Celery, Redis, Vue 3, Vite
4. WhisperX integrated as git submodule at `ai_services/whisperx/`
5. Git repository configured with .gitignore for Python and Node
6. Basic README with setup instructions
7. Local development servers can run (backend on port 8000, frontend on port 5173)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Starter Template Decisions</section>
        <snippet>Frontend uses create-vue with TypeScript, Router, and Pinia. Backend uses manual Docker Compose setup with FastAPI, Celery worker, and Redis for GPU-enabled WhisperX integration.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>GPU Environment Requirements</section>
        <snippet>WhisperX requires NVIDIA GPU with 8GB+ VRAM, CUDA 11.8+, and nvidia-docker2 runtime. Docker Compose must configure GPU resources with reservations and NVIDIA_VISIBLE_DEVICES environment variable.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Testing Strategy</section>
        <snippet>Backend uses pytest with 70%+ coverage target. Frontend uses Vitest with Vue Testing Library. Tests organized in backend/tests/ and frontend/src/ with conftest.py fixtures for mocking.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure and Boundaries</section>
        <snippet>Complete project structure defines backend/ with Docker Compose, Dockerfile, requirements.txt, and app/ directory. Frontend/ follows create-vue structure with src/, components/, views/, stores/, and router/.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Overview</section>
        <snippet>Epic 1 establishes foundational infrastructure with FastAPI backend, Celery workers, WhisperX integration as git submodule, and Vue 3 frontend. Implements complete upload-transcribe-display workflow.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Dependencies and Integrations</section>
        <snippet>Backend requires FastAPI 0.120.x, Celery 5.5.3+, Redis 5.x, PyTorch 2.x, pytest 7.x. Frontend requires Vue 3.x, Vue Router 4.x, Pinia, TypeScript 5.x, Vite, and Vitest.</snippet>
      </doc>
    </docs>
    <code>
      <note>This is Story 1.1 - the foundational scaffolding story. No existing code to integrate with. All files will be created new.</note>
      <future-artifact>
        <path>backend/app/ai_services/base.py</path>
        <kind>interface</kind>
        <symbol>TranscriptionService</symbol>
        <reason>Abstract base class defining transcription service interface for WhisperX and future AI service implementations</reason>
      </future-artifact>
      <future-artifact>
        <path>backend/app/ai_services/whisperx_service.py</path>
        <kind>service</kind>
        <symbol>WhisperXService</symbol>
        <reason>WhisperX implementation of TranscriptionService interface</reason>
      </future-artifact>
      <future-artifact>
        <path>backend/app/main.py</path>
        <kind>api</kind>
        <symbol>FastAPI app</symbol>
        <reason>FastAPI application initialization with CORS middleware and placeholder endpoints</reason>
      </future-artifact>
      <future-artifact>
        <path>backend/app/config.py</path>
        <kind>config</kind>
        <symbol>Settings</symbol>
        <reason>Pydantic Settings class loading environment variables from .env file</reason>
      </future-artifact>
      <future-artifact>
        <path>backend/app/celery_utils.py</path>
        <kind>worker</kind>
        <symbol>Celery instance</symbol>
        <reason>Celery worker configuration connecting to Redis broker and result backend</reason>
      </future-artifact>
    </code>
    <dependencies>
      <backend ecosystem="Python 3.12+">
        <package name="fastapi" version="0.120.x" purpose="Web framework, API endpoints, auto-docs"/>
        <package name="uvicorn" version="latest" purpose="ASGI server for FastAPI"/>
        <package name="celery" version="5.5.3+" purpose="Async task queue"/>
        <package name="redis" version="5.x" purpose="Python Redis client"/>
        <package name="pydantic" version="2.x" purpose="Data validation, settings management"/>
        <package name="pydantic-settings" version="2.x" purpose="Environment variable configuration"/>
        <package name="python-multipart" version="latest" purpose="Multipart file upload handling"/>
        <package name="python-ffmpeg" version="latest" purpose="Media file validation (wrapper only - binary installed via apt-get)"/>
        <package name="torch" version="2.1.2" purpose="PyTorch for WhisperX (install via CUDA 11.8 index URL)"/>
        <package name="torchaudio" version="2.1.2" purpose="Audio processing (install via CUDA 11.8 index URL)"/>
        <package name="pytest" version="7.x" purpose="Testing framework"/>
        <package name="pytest-mock" version="3.x" purpose="Mocking for tests"/>
        <note>WhisperX installed as git submodule at backend/app/ai_services/whisperx/</note>
      </backend>
      <frontend ecosystem="Node.js 20.x LTS">
        <package name="vue" version="3.x" purpose="Frontend framework"/>
        <package name="vue-router" version="4.x" purpose="Client-side routing"/>
        <package name="pinia" version="latest" purpose="State management"/>
        <package name="typescript" version="5.x" purpose="Type safety"/>
        <package name="vite" version="latest" purpose="Build tool, dev server"/>
        <package name="vitest" version="latest" purpose="Testing framework"/>
        <package name="@vue/test-utils" version="latest" purpose="Component testing"/>
      </frontend>
      <infrastructure>
        <service name="Redis" version="7-alpine" purpose="Message broker + result backend"/>
        <service name="Docker" purpose="Containerization"/>
        <service name="nvidia-docker2" purpose="GPU access in containers"/>
        <service name="CUDA" version="11.8+" purpose="GPU acceleration for WhisperX"/>
      </infrastructure>
    </dependencies>
  </artifacts>

  <constraints>
    <critical-technical-decisions>
      <constraint priority="critical">
        <title>FFmpeg Binary Installation</title>
        <description>python-ffmpeg is only a wrapper - must install actual ffmpeg binary via apt-get in Dockerfile BEFORE Python dependencies. WhisperX and torchaudio require ffmpeg command-line tool.</description>
        <failure-mode>Without this, Story 1.3 transcription tasks will fail with "ffmpeg: command not found"</failure-mode>
      </constraint>
      <constraint priority="critical">
        <title>PyTorch CUDA Version Binding</title>
        <description>Install PyTorch with CUDA 11.8-specific index URL in Dockerfile: --index-url https://download.pytorch.org/whl/cu118. Use torch==2.1.2 torchaudio==2.1.2</description>
        <failure-mode>Without this, torch.cuda.is_available() returns False, GPU not detected, NFR001 performance targets impossible</failure-mode>
      </constraint>
      <constraint priority="important">
        <title>Docker Compose Startup Order</title>
        <description>Add Redis health check (redis-cli ping) and depends_on with condition: service_healthy for web/worker services</description>
        <failure-mode>Race condition causing web/worker crashes and restart loops</failure-mode>
      </constraint>
      <constraint priority="good-practice">
        <title>Environment Variable Template</title>
        <description>Create .env.example with all required variables: CELERY_BROKER_URL, CELERY_RESULT_BACKEND, WHISPER_MODEL, WHISPER_DEVICE, WHISPER_COMPUTE_TYPE, UPLOAD_DIR, MAX_FILE_SIZE, MAX_DURATION_HOURS, CORS_ORIGINS</description>
        <failure-mode>New developers/agents don't know which variables to configure</failure-mode>
      </constraint>
    </critical-technical-decisions>
    <architectural-patterns>
      <pattern>Service Separation: Web service (FastAPI), worker service (Celery), message broker (Redis)</pattern>
      <pattern>AI Service Abstraction: WhisperX as git submodule with abstract interface pattern for future extensibility</pattern>
      <pattern>Configuration Management: Pydantic Settings loading from .env file</pattern>
      <pattern>GPU Environment: Docker Compose with nvidia-docker2 runtime, CUDA 11.8+ required</pattern>
      <pattern>Model Caching: Docker volume for WhisperX models at /root/.cache/whisperx to avoid re-download</pattern>
    </architectural-patterns>
    <testing-requirements>
      <requirement>Backend: pytest + pytest-mock for unit/integration tests, 70%+ coverage target</requirement>
      <requirement>Frontend: Vitest + @vue/test-utils for component tests, 60%+ coverage target</requirement>
      <requirement>Test infrastructure setup required in Story 1.1 (pytest.ini, conftest.py)</requirement>
    </testing-requirements>
  </constraints>

  <interfaces>
    <interface>
      <name>TranscriptionService</name>
      <kind>Abstract Base Class</kind>
      <signature>
class TranscriptionService(ABC):
    @abstractmethod
    def transcribe(self, audio_path: str, language: str = "en") -> List[Dict[str, Any]]:
        """Returns list of segments with start, end, text fields"""
        pass
      </signature>
      <path>backend/app/ai_services/base.py</path>
    </interface>
    <interface>
      <name>WhisperXService</name>
      <kind>Service Implementation</kind>
      <signature>
class WhisperXService(TranscriptionService):
    def transcribe(self, audio_path: str, language: str = "en") -> List[Dict[str, Any]]:
        # WhisperX GPU-accelerated transcription implementation
        pass
      </signature>
      <path>backend/app/ai_services/whisperx_service.py</path>
    </interface>
    <interface>
      <name>Settings</name>
      <kind>Pydantic Configuration</kind>
      <signature>
class Settings(BaseSettings):
    CELERY_BROKER_URL: str
    CELERY_RESULT_BACKEND: str
    WHISPER_MODEL: str = "large-v2"
    WHISPER_DEVICE: str = "cuda"
    # ... other config fields
      </signature>
      <path>backend/app/config.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
Backend uses pytest framework with pytest-mock for unit and integration tests targeting 70%+ coverage. Tests organized in backend/tests/ directory with conftest.py providing fixtures including TestClient for FastAPI endpoints and mock_whisperx fixture to avoid GPU dependency. Frontend uses Vitest with @vue/test-utils for component tests targeting 60%+ coverage. Tests colocated with source in src/ directory following .test.ts naming convention. E2E tests deferred to Story 2.7 using Playwright.
    </standards>
    <locations>
      <backend>backend/tests/</backend>
      <backend-config>backend/pytest.ini</backend-config>
      <frontend>frontend/src/**/*.test.ts</frontend>
      <frontend-config>frontend/vitest.config.ts</frontend-config>
    </locations>
    <ideas>
      <test-idea ac="AC1" priority="high">
        <description>Backend structure validation test</description>
        <details>Verify all required backend directories exist: app/, app/services/, app/tasks/, app/ai_services/, app/models.py, app/main.py, app/config.py, app/celery_utils.py</details>
      </test-idea>
      <test-idea ac="AC2" priority="high">
        <description>Frontend structure validation test</description>
        <details>Verify create-vue generated expected structure: src/, src/components/, src/views/, src/stores/, src/router/, src/services/, src/types/</details>
      </test-idea>
      <test-idea ac="AC3" priority="high">
        <description>Dependencies installed test</description>
        <details>Backend: Check requirements.txt contains all required packages. Frontend: Check package.json contains Vue 3, Router, Pinia, Vite, TypeScript</details>
      </test-idea>
      <test-idea ac="AC4" priority="high">
        <description>Git submodule validation test</description>
        <details>Verify .gitmodules exists and WhisperX submodule is initialized at backend/app/ai_services/whisperx/</details>
      </test-idea>
      <test-idea ac="AC5" priority="medium">
        <description>Git configuration test</description>
        <details>Verify .gitignore files exist for backend (Python, Docker, uploads/) and frontend (node_modules/, dist/)</details>
      </test-idea>
      <test-idea ac="AC7" priority="critical">
        <description>Development server startup test</description>
        <details>Backend: docker-compose up starts all services (web, worker, redis, flower) and web accessible at localhost:8000/docs. Frontend: npm run dev starts Vite at localhost:5173</details>
      </test-idea>
      <test-idea ac="Task7" priority="high">
        <description>Test infrastructure validation</description>
        <details>Backend: pytest.ini exists and tests/ directory with conftest.py created. Frontend: Vitest configuration from create-vue verified</details>
      </test-idea>
    </ideas>
  </tests>
</story-context>
