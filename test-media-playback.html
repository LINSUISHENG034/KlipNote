<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Playback API Test - Story 2.1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        video, audio {
            width: 100%;
            margin: 10px 0;
            background: black;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #137fec;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0f6bc9;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Media Playback API Test - Story 2.1</h1>
    <p><strong>Test Cases:</strong> AC #6 (Browser Compatibility), NFR001 (Performance)</p>

    <div class="test-section">
        <h2>Test Job IDs (Update with actual job_ids)</h2>
        <p>MP3: <input type="text" id="mp3JobId" value="91a9eab9-eb5c-4114-be3c-3c2d1c7f65a1" style="width: 300px;"></p>
        <p>WAV: <input type="text" id="wavJobId" value="f119d603-c840-4b9b-b183-f73b90228111" style="width: 300px;"></p>
        <p>WMA: <input type="text" id="wmaJobId" value="81f883eb-6896-4ebf-9335-6f05493e9816" style="width: 300px;"></p>
    </div>

    <div class="test-section">
        <h2>1. MP3 Audio Playback Test</h2>
        <audio id="audioPlayer" controls></audio>
        <div class="controls">
            <button onclick="loadMp3()">Load MP3</button>
            <button onclick="testSeek(audioPlayer, 5)">Seek to 5s</button>
            <button onclick="testSeek(audioPlayer, 10)">Seek to 10s</button>
        </div>
        <div id="audioResults"></div>
    </div>

    <div class="test-section">
        <h2>2. WAV Audio Playback Test</h2>
        <audio id="wavPlayer" controls></audio>
        <div class="controls">
            <button onclick="loadWav()">Load WAV</button>
            <button onclick="testSeek(wavPlayer, 3)">Seek to 3s</button>
        </div>
        <div id="wavResults"></div>
    </div>

    <div class="test-section">
        <h2>3. WMA Audio Playback Test</h2>
        <audio id="wmaPlayer" controls></audio>
        <div class="controls">
            <button onclick="loadWma()">Load WMA</button>
            <button onclick="testSeek(wmaPlayer, 3)">Seek to 3s</button>
        </div>
        <div id="wmaResults"></div>
    </div>

    <div class="test-section">
        <h2>4. Network Monitoring (DevTools Required)</h2>
        <div class="result info">
            <strong>Instructions:</strong>
            <ol>
                <li>Open DevTools (F12) → Network tab</li>
                <li>Load a media file above</li>
                <li>Click "Seek to" buttons and observe:</li>
                <ul>
                    <li>Initial request: 200 OK with full file</li>
                    <li>Seek requests: 206 Partial Content</li>
                    <li>Content-Range header present (e.g., "bytes 0-1023/511547")</li>
                    <li>Seek response time &lt; 1s (NFR001)</li>
                </ul>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="summary" class="result info">
            <p><strong>Browser:</strong> <span id="browserInfo"></span></p>
            <p><strong>Tests Completed:</strong> <span id="testsCompleted">0</span></p>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000/media';
        let testsCompleted = 0;

        // Detect browser
        document.getElementById('browserInfo').textContent = navigator.userAgent;

        function loadMp3() {
            const jobId = document.getElementById('mp3JobId').value;
            loadMedia('audioPlayer', jobId, 'audioResults', 'MP3');
        }

        function loadWav() {
            const jobId = document.getElementById('wavJobId').value;
            loadMedia('wavPlayer', jobId, 'wavResults', 'WAV');
        }

        function loadWma() {
            const jobId = document.getElementById('wmaJobId').value;
            loadMedia('wmaPlayer', jobId, 'wmaResults', 'WMA');
        }

        async function loadMedia(playerId, jobId, resultId, format) {
            const player = document.getElementById(playerId);
            const resultDiv = document.getElementById(resultId);
            const url = `${BASE_URL}/${jobId}`;

            resultDiv.innerHTML = '<div class="result info">Loading...</div>';

            try {
                // Test endpoint response
                const startTime = performance.now();
                const response = await fetch(url);
                const loadTime = performance.now() - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                const acceptRanges = response.headers.get('accept-ranges');
                const contentLength = response.headers.get('content-length');

                // Set player source
                player.src = url;

                // Display results
                resultDiv.innerHTML = `
                    <div class="result success">
                        <strong>✓ ${format} Loaded Successfully</strong>
                        <pre>Content-Type: ${contentType}
Accept-Ranges: ${acceptRanges}
Content-Length: ${contentLength} bytes
Load Time: ${loadTime.toFixed(2)}ms</pre>
                    </div>
                `;

                testsCompleted++;
                updateSummary();

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <strong>✗ ${format} Load Failed</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testSeek(player, seconds) {
            const startTime = performance.now();

            return new Promise((resolve) => {
                player.currentTime = seconds;

                player.addEventListener('seeked', function onSeeked() {
                    const seekTime = performance.now() - startTime;
                    const resultId = player.id === 'audioPlayer' ? 'audioResults' :
                                    player.id === 'wavPlayer' ? 'wavResults' : 'wmaResults';
                    const resultDiv = document.getElementById(resultId);

                    const performance_met = seekTime < 1000;
                    const resultClass = performance_met ? 'success' : 'error';
                    const icon = performance_met ? '✓' : '✗';

                    resultDiv.innerHTML += `
                        <div class="result ${resultClass}">
                            <strong>${icon} Seek to ${seconds}s</strong>
                            <p>Time: ${seekTime.toFixed(2)}ms (NFR001: ${performance_met ? 'PASS' : 'FAIL'} - must be &lt;1000ms)</p>
                        </div>
                    `;

                    player.removeEventListener('seeked', onSeeked);
                    resolve();
                }, { once: true });
            });
        }

        function updateSummary() {
            document.getElementById('testsCompleted').textContent = testsCompleted;
        }
    </script>
</body>
</html>
